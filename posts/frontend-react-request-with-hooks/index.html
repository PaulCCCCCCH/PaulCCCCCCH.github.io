<!DOCTYPE html><html lang="en" ><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width, initial-scale=1, shrink-to-fit=no"><meta name="day-prompt" content="days ago"><meta name="hour-prompt" content="hours ago"><meta name="minute-prompt" content="minutes ago"><meta name="justnow-prompt" content="just now"><meta name="generator" content="Jekyll v4.2.1" /><meta property="og:title" content="On Encapsulating HTTP Requests with React Hooks" /><meta name="author" content="Chonghan Chen" /><meta property="og:locale" content="en" /><meta name="description" content="Introduction" /><meta property="og:description" content="Introduction" /><link rel="canonical" href="https://paulcccccch.github.io/posts/frontend-react-request-with-hooks/" /><meta property="og:url" content="https://paulcccccch.github.io/posts/frontend-react-request-with-hooks/" /><meta property="og:site_name" content="Chonghan Chen" /><meta property="og:type" content="article" /><meta property="article:published_time" content="2022-06-20T14:00:00-04:00" /><meta name="twitter:card" content="summary" /><meta property="twitter:title" content="On Encapsulating HTTP Requests with React Hooks" /><meta name="twitter:site" content="@paulcccccch" /><meta name="twitter:creator" content="@Chonghan Chen" /><meta name="google-site-verification" content="google_meta_tag_verification" /> <script type="application/ld+json"> {"author":{"@type":"Person","name":"Chonghan Chen"},"description":"Introduction","headline":"On Encapsulating HTTP Requests with React Hooks","dateModified":"2022-06-20T14:00:00-04:00","datePublished":"2022-06-20T14:00:00-04:00","url":"https://paulcccccch.github.io/posts/frontend-react-request-with-hooks/","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://paulcccccch.github.io/posts/frontend-react-request-with-hooks/"},"@context":"https://schema.org"}</script><title>On Encapsulating HTTP Requests with React Hooks | Chonghan Chen</title><link rel="apple-touch-icon" sizes="180x180" href="/assets/img/favicons/apple-touch-icon.png"><link rel="icon" type="image/png" sizes="32x32" href="/assets/img/favicons/favicon-32x32.png"><link rel="icon" type="image/png" sizes="16x16" href="/assets/img/favicons/favicon-16x16.png"><link rel="manifest" href="/assets/img/favicons/site.webmanifest"><link rel="shortcut icon" href="/assets/img/favicons/favicon.ico"><meta name="apple-mobile-web-app-title" content="Chonghan Chen"><meta name="application-name" content="Chonghan Chen"><meta name="msapplication-TileColor" content="#da532c"><meta name="msapplication-config" content="/assets/img/favicons/browserconfig.xml"><meta name="theme-color" content="#ffffff"><link rel="preconnect" href="https://fonts.gstatic.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://fonts.gstatic.com"><link rel="preconnect" href="https://www.google-analytics.com" crossorigin="use-credentials"><link rel="dns-prefetch" href="https://www.google-analytics.com"><link rel="preconnect" href="https://www.googletagmanager.com" crossorigin="anonymous"><link rel="dns-prefetch" href="https://www.googletagmanager.com"><link rel="preconnect" href="https://cdn.jsdelivr.net"><link rel="dns-prefetch" href="https://cdn.jsdelivr.net"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@4.0.0/dist/css/bootstrap.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/@fortawesome/fontawesome-free@5.11.2/css/all.min.css"><link rel="stylesheet" href="/assets/css/style.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/magnific-popup@1.1.0/dist/magnific-popup.min.css"> <script src="https://cdn.jsdelivr.net/npm/jquery@3/dist/jquery.min.js"></script><body data-spy="scroll" data-target="#toc"><div id="sidebar" class="d-flex flex-column align-items-end" lang="en"><div class="profile-wrapper text-center"><div id="avatar"> <a href="/" alt="avatar" class="mx-auto"> <img src="/assets/img/avatar.png" alt="avatar" onerror="this.style.display='none'"> </a></div><div class="site-title mt-3"> <a href="/">Chonghan Chen</a></div><div class="site-subtitle font-italic">Full-Stack Dev | Deep Learning </br> Student at CMU </br></div></div><ul class="w-100"><li class="nav-item"> <a href="/" class="nav-link"> <i class="fa-fw fas fa-home ml-xl-3 mr-xl-3 unloaded"></i> <span>HOME</span> </a><li class="nav-item"> <a href="/about/" class="nav-link"> <i class="fa-fw fas fa-info-circle ml-xl-3 mr-xl-3 unloaded"></i> <span>ABOUT</span> </a><li class="nav-item"> <a href="/projects/" class="nav-link"> <i class="fa-fw fas fa-lightbulb ml-xl-3 mr-xl-3 unloaded"></i> <span>PROJECTS</span> </a><li class="nav-item"> <a href="/categories/" class="nav-link"> <i class="fa-fw fas fa-stream ml-xl-3 mr-xl-3 unloaded"></i> <span>CATEGORIES</span> </a><li class="nav-item"> <a href="/archives/" class="nav-link"> <i class="fa-fw fas fa-archive ml-xl-3 mr-xl-3 unloaded"></i> <span>ARCHIVES</span> </a><li class="nav-item"> <a href="/tags/" class="nav-link"> <i class="fa-fw fas fa-tag ml-xl-3 mr-xl-3 unloaded"></i> <span>TAGS</span> </a></ul><div class="sidebar-bottom mt-auto d-flex flex-wrap justify-content-center align-items-center"> <a href="https://github.com/paulcccccch" aria-label="github" class="order-3" target="_blank" rel="noopener"> <i class="fab fa-github"></i> </a> <a href="https://twitter.com/paulcccccch" aria-label="twitter" class="order-4" target="_blank" rel="noopener"> <i class="fab fa-twitter"></i> </a> <a href=" javascript:location.href = 'mailto:' + ['chonghac','cs.cmu.edu'].join('@')" aria-label="email" class="order-5" > <i class="fas fa-envelope"></i> </a> <a href="/feed.xml" aria-label="rss" class="order-6" > <i class="fas fa-rss"></i> </a> <span class="icon-border order-2"></span> <span id="mode-toggle-wrapper" class="order-1"> <i class="mode-toggle fas fa-adjust"></i> <script type="text/javascript"> class ModeToggle { static get MODE_KEY() { return "mode"; } static get DARK_MODE() { return "dark"; } static get LIGHT_MODE() { return "light"; } constructor() { if (this.hasMode) { if (this.isDarkMode) { if (!this.isSysDarkPrefer) { this.setDark(); } } else { if (this.isSysDarkPrefer) { this.setLight(); } } } var self = this; /* always follow the system prefers */ this.sysDarkPrefers.addListener(function() { if (self.hasMode) { if (self.isDarkMode) { if (!self.isSysDarkPrefer) { self.setDark(); } } else { if (self.isSysDarkPrefer) { self.setLight(); } } self.clearMode(); } self.updateMermaid(); }); } /* constructor() */ setDark() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.DARK_MODE); } setLight() { $('html').attr(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); sessionStorage.setItem(ModeToggle.MODE_KEY, ModeToggle.LIGHT_MODE); } clearMode() { $('html').removeAttr(ModeToggle.MODE_KEY); sessionStorage.removeItem(ModeToggle.MODE_KEY); } get sysDarkPrefers() { return window.matchMedia("(prefers-color-scheme: dark)"); } get isSysDarkPrefer() { return this.sysDarkPrefers.matches; } get isDarkMode() { return this.mode == ModeToggle.DARK_MODE; } get isLightMode() { return this.mode == ModeToggle.LIGHT_MODE; } get hasMode() { return this.mode != null; } get mode() { return sessionStorage.getItem(ModeToggle.MODE_KEY); } /* get the current mode on screen */ get modeStatus() { if (this.isDarkMode || (!this.hasMode && this.isSysDarkPrefer) ) { return ModeToggle.DARK_MODE; } else { return ModeToggle.LIGHT_MODE; } } updateMermaid() { if (typeof mermaid !== "undefined") { let expectedTheme = (this.modeStatus === ModeToggle.DARK_MODE? "dark" : "default"); let config = { theme: expectedTheme }; /* re-render the SVG › <https://github.com/mermaid-js/mermaid/issues/311#issuecomment-332557344> */ $(".mermaid").each(function() { let svgCode = $(this).prev().children().html(); $(this).removeAttr("data-processed"); $(this).html(svgCode); }); mermaid.initialize(config); mermaid.init(undefined, ".mermaid"); } } flipMode() { if (this.hasMode) { if (this.isSysDarkPrefer) { if (this.isLightMode) { this.clearMode(); } else { this.setLight(); } } else { if (this.isDarkMode) { this.clearMode(); } else { this.setDark(); } } } else { if (this.isSysDarkPrefer) { this.setLight(); } else { this.setDark(); } } this.updateMermaid(); } /* flipMode() */ } /* ModeToggle */ let toggle = new ModeToggle(); $(".mode-toggle").click(function() { toggle.flipMode(); }); </script> </span></div></div><div id="topbar-wrapper" class="row justify-content-center topbar-down"><div id="topbar" class="col-11 d-flex h-100 align-items-center justify-content-between"> <span id="breadcrumb"> <span> <a href="/"> Home </a> </span> <span>On Encapsulating HTTP Requests with React Hooks</span> </span> <i id="sidebar-trigger" class="fas fa-bars fa-fw"></i><div id="topbar-title"> Post</div><i id="search-trigger" class="fas fa-search fa-fw"></i> <span id="search-wrapper" class="align-items-center"> <i class="fas fa-search fa-fw"></i> <input class="form-control" id="search-input" type="search" aria-label="search" autocomplete="off" placeholder="Search..."> <i class="fa fa-times-circle fa-fw" id="search-cleaner"></i> </span> <span id="search-cancel" >Cancel</span></div></div><div id="main-wrapper"><div id="main"><div class="row"><div id="post-wrapper" class="col-12 col-lg-11 col-xl-8"><div class="post pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><h1 data-toc-skip>On Encapsulating HTTP Requests with React Hooks</h1><div class="post-meta text-muted d-flex flex-column"><div> <span class="semi-bold"> Chonghan Chen </span> on <span class="timeago " data-toggle="tooltip" data-placement="bottom" title="Mon, Jun 20, 2022, 2:00 PM -0400" >Jun 20, 2022<i class="unloaded">2022-06-20T14:00:00-04:00</i> </span></div><div> <span class="readtime" data-toggle="tooltip" data-placement="bottom" title="2464 words">13 min read</span></div></div><div class="post-content"><h1 id="introduction">Introduction</h1><h2 id="the-position-of-hooks-in-the-big-picture">The Position of Hooks in the Big Picture</h2><p>In my opinion, the key goal of Scaffolding in software engineering is to simplify two things: development and maintenance. A great way to achieve this goal is through <strong>logic sharing</strong>. By sharing logic, you write less code during development, and locate bugs more quickly during maintenance.</p><p>This is the direction to which frontend development world is evolving. With the introduction of frontend frameworks, people are allowed to <strong>define and reuse DOM elements</strong>. Also, we are able to <strong>use pre-defined and shared data-binding and rendering logic</strong>, which all main-stream frontend frameworks provide. Recently, logic sharing is pushed even further. For example, <code class="language-plaintext highlighter-rouge">Vue3.js</code> introduced Composition APIs to allow grouping functions handling the same data objects together, ignorant of which component is using them, and <code class="language-plaintext highlighter-rouge">React</code> introduced react <code class="language-plaintext highlighter-rouge">Hooks</code> to allow easier sharing of logic around certain states.</p><p>For this post, we will focus on <code class="language-plaintext highlighter-rouge">React</code> and <code class="language-plaintext highlighter-rouge">Hooks</code>.</p><h2 id="my-understanding-of-hooks">My Understanding of Hooks</h2><p>From my understanding, React <code class="language-plaintext highlighter-rouge">Hooks</code> allows a more flexible way of handling <code class="language-plaintext highlighter-rouge">state</code>. <code class="language-plaintext highlighter-rouge">state</code> has been around since <code class="language-plaintext highlighter-rouge">React</code> was born, but the <strong>handling</strong> (e.g., updating and rendering) of a state seems to be privately owned by a component, which cannot be shared easily. Imagine you have two components, each having some states and hanlder functions for that state. Both components use <code class="language-plaintext highlighter-rouge">stateA</code>.</p><div class="language-html highlighter-rouge"><div class="code-header"> <span text-data=" HTML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
</pre><td class="rouge-code"><pre>Component X {
    stateA, 
    stateB, 
    handlersForStateA, // can be 1000 lines of code
    handlersForStateB,
    
    render: 
    <span class="nt">&lt;div&gt;</span>
        <span class="nt">&lt;DOM1</span> <span class="na">state=</span><span class="s">{stateA}</span> <span class="nt">/&gt;</span>
    	<span class="nt">&lt;DOM2</span> <span class="na">state=</span><span class="s">{stateB}</span> <span class="nt">/&gt;</span>
    <span class="nt">&lt;/div&gt;</span>
}
   	
Component Y {
	stateA,
	stateC,
	handlersForStateA,	// can be 1000 lines of code
    handlersForStateC,
            
    render:
	<span class="nt">&lt;div&gt;</span>
		<span class="nt">&lt;DOM1</span> <span class="na">state=</span><span class="s">{stateA}</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;DOM2</span> <span class="na">state=</span><span class="s">{stateC}</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;/div&gt;</span>
}

</pre></table></code></div></div><p>How would you share the logic here? Without Hooks, you <strong>have to share logic with a helper component</strong>. The helper component looks like this</p><div class="language-html highlighter-rouge"><div class="code-header"> <span text-data=" HTML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
</pre><td class="rouge-code"><pre>Component Helper {
	stateA,
	handlersForStateA,

	render:
		<span class="nt">&lt;DOM1</span> <span class="na">state=</span><span class="s">{stateA}</span> <span class="nt">/&gt;</span>
}
</pre></table></code></div></div><p>Then, you can simply change component X and Y to</p><div class="language-html highlighter-rouge"><div class="code-header"> <span text-data=" HTML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre>Component X {
    // No need for state A here anymore, may save 1000 lines of code
	stateB,
	handlersForStateB,
        
	render:
	<span class="nt">&lt;div&gt;</span>
		<span class="nt">&lt;Helper</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;DOM2</span> <span class="na">state=</span><span class="s">{stateB}</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;/div&gt;</span>
}

Component Y {
    // No need for state A here anymore, may save 1000 lines of code
	stateC,
	handlersForStateC,
        
	render:
	<span class="nt">&lt;div&gt;</span>
		<span class="nt">&lt;Helper</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;DOM2</span> <span class="na">state=</span><span class="s">{stateC}</span> <span class="nt">/&gt;</span>
	<span class="nt">&lt;/div&gt;</span>
}
</pre></table></code></div></div><p>Thus, we extracted logic for stateA and freed ourselves from repeating that 1000 lines of code. However, what if we want to render stateA differently for component X and Y? For example, I want to wrap stateA in a popup in component X, and want to wrap stateB in a table in component Y. How do I achieve this? The answer is, there is no elegant way of doing this other than creating more helper components for encapsulation.</p><div class="language-html highlighter-rouge"><div class="code-header"> <span text-data=" HTML "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
</pre><td class="rouge-code"><pre>Component PopupHelper{
	render:
		<span class="nt">&lt;Popup&gt;</span>
			<span class="nt">&lt;Helper</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;/Popup&gt;</span>
}

Component TableHelper{
	render:
		<span class="nt">&lt;Table&gt;</span>
			<span class="nt">&lt;Helper</span> <span class="nt">/&gt;</span>
		<span class="nt">&lt;/Table&gt;</span>
}


</pre></table></code></div></div><p>Then, we use <code class="language-plaintext highlighter-rouge">PopupHelper</code> in <code class="language-plaintext highlighter-rouge">Component X</code> and <code class="language-plaintext highlighter-rouge">TableHelper</code> in <code class="language-plaintext highlighter-rouge">Component Y</code>. This is frustrating, because <strong>what we really want to share the state part (state + handlers), but we are forced to create a shared component (state + handlers + rendering)</strong>.</p><p>This is where <code class="language-plaintext highlighter-rouge">Hooks</code> comes into rescue. A hook defines a state (or a set of states) and the logic regarding that state. It is useful to think of it as a component without a rendering logic. With hooks, you can easily decouple state logic with view, thus allowing more flexible logic sharing.</p><p><code class="language-plaintext highlighter-rouge">Hooks</code> is a powerful tool for logic sharing. In this post, we investigate specifically how we encapsulate the logic around sending HTTP requests to allow the most sharing in the most elegant way possible.</p><h1 id="problem-setup">Problem Setup</h1><h2 id="request-with-state">Request with State</h2><p>All HTTP requests need to read from several states, for example, authentication state, frontend side throttling state, and server root url (suppose the user can select which backend to talk to). We assume all state information is aggregated to one object called <code class="language-plaintext highlighter-rouge">apiState</code> can be read from one <code class="language-plaintext highlighter-rouge">useApiState</code> call.</p><h2 id="http-request-library">HTTP Request Library</h2><p>Imagine we have a library to help us send HTTP request, which we can use as</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="nx">lib</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">state</span><span class="p">:</span> <span class="nx">object</span><span class="p">)</span>	<span class="c1">// For Get requests</span>
<span class="nx">lib</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="nx">url</span><span class="p">:</span> <span class="nx">string</span><span class="p">,</span> <span class="nx">data</span><span class="p">:</span> <span class="nx">object</span><span class="p">,</span> <span class="nx">state</span><span class="p">:</span> <span class="nx">object</span><span class="p">)</span>	<span class="c1">// For POST requests</span>
</pre></table></code></div></div><p>Both functions return a <code class="language-plaintext highlighter-rouge">Promise</code> object, and you can use <code class="language-plaintext highlighter-rouge">await</code> or <code class="language-plaintext highlighter-rouge">.then()</code> to resolve. We omit other request types as they are not very different from these two.</p><h2 id="restful-api-endpoints">RESTful API Endpoints</h2><p>We assume the endpoints follow <code class="language-plaintext highlighter-rouge">RESTful</code> API styles. For illustration purposes, we consider the following three endpoints we need to cover</p><ol><li>Type 1, URL only, e.g. <code class="language-plaintext highlighter-rouge">GET https://example.com/user</code><li>Type 2, URL with path parameters, e.g. <code class="language-plaintext highlighter-rouge">GET https://example.com/user?first=paul&amp;last=chen</code><li>Type 3, URL with path parameters and request body, e.g. <code class="language-plaintext highlighter-rouge">POST https://example.com/user</code> with <code class="language-plaintext highlighter-rouge">data = {first: paul, last: chen}</code></ol><h2 id="goal">Goal</h2><p>The goal is to encapsulate HTTP requests, so that we don’t need to worry about all the HTTP intricacies in the components. For example, if I want to fetch user data from the server, I should be able to call them like normal functions, e.g.</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">users</span> <span class="o">=</span> <span class="k">await</span> <span class="nx">fetch_user</span><span class="p">(</span><span class="nx">param1</span><span class="p">,</span> <span class="nx">param2</span><span class="p">);</span>
</pre></table></code></div></div><p>or this</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
</pre><td class="rouge-code"><pre><span class="kd">let</span> <span class="nx">users</span>
<span class="nx">fetch_user</span><span class="p">(</span><span class="nx">param1</span><span class="p">,</span> <span class="nx">param2</span><span class="p">,</span> 
	<span class="p">(</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">users</span> <span class="o">=</span> <span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">,</span>   <span class="c1">// on success</span>
	<span class="p">(</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">users</span> <span class="o">=</span> <span class="p">[]</span> 		<span class="c1">// on error</span>
<span class="p">)</span>
</pre></table></code></div></div><p>or anything equivalent. I shouldn’t be assembling request url / headers, etc in my component. I omitted the handling of loading and error state and other things that do not add complexity to our design.</p><h1 id="a-naive-approach-pure-javascript">A Naive Approach (Pure Javascript)</h1><p>I used to work mostly with <code class="language-plaintext highlighter-rouge">Vue.js</code> and this solution is what I used first. This approach is framework-agnostic. All implementations are based on pure JavaScript.</p><p>I first create a generic requester for each request types</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">sendGETRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">apiState</span> <span class="o">=</span> <span class="nx">getApiState</span><span class="p">()</span> <span class="c1">// Problem: how do we get state here?</span>
	<span class="k">return</span> <span class="nx">lib</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">apiState</span><span class="p">.</span><span class="nx">server_root</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">apiState</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">sendPOSTRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">apiState</span> <span class="o">=</span> <span class="nx">getApiState</span><span class="p">()</span> <span class="c1">// Problem: how do we get state here?</span>
	<span class="k">return</span> <span class="nx">lib</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">apiState</span><span class="p">.</span><span class="nx">server_root</span><span class="p">}${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">,</span> <span class="nx">apiState</span><span class="p">)</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Then, we encapsulate all API endpoints</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">APIGetUsers</span><span class="p">()</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">sendGetRequest</span><span class="p">(</span><span class="dl">"</span><span class="s2">/user</span><span class="dl">"</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">APIGetUser</span><span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">last</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">sendGetRequest</span><span class="p">(</span><span class="s2">`/user?first=</span><span class="p">${</span><span class="nx">first</span><span class="p">}</span><span class="s2">&amp;last=</span><span class="p">${</span><span class="nx">last</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
<span class="p">}</span>

<span class="kd">const</span> <span class="nx">APIPostUser</span><span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">last</span><span class="p">)</span> <span class="p">{</span>
	<span class="k">return</span> <span class="nx">sendPostRequest</span><span class="p">(</span><span class="s2">`/user`</span><span class="p">,</span> <span class="p">{</span><span class="nx">first</span><span class="p">,</span> <span class="nx">last</span><span class="p">})</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Then, we can make these calls anywhere in our program, as if they are plain old helper functions. The problem is, how do we get the <code class="language-plaintext highlighter-rouge">apiState</code> here? We cannot use <code class="language-plaintext highlighter-rouge">useApiState</code>, because these functions are neither functional components nor react hooks. We could read from <code class="language-plaintext highlighter-rouge">localStorage</code> or <code class="language-plaintext highlighter-rouge">Redux</code> storage, but this means you cannot control the scope of the state (they are always global). For example, it becomes impossible for you to use two different <code class="language-plaintext highlighter-rouge">apiState</code> in two components. Plus, this does not feel React at all.</p><h1 id="what-most-bloggers-suggest-w-hooks">What Most Bloggers Suggest (w/ Hooks)</h1><p>As I moved from <code class="language-plaintext highlighter-rouge">Vue.js</code> to <code class="language-plaintext highlighter-rouge">React.js</code>, I was amazed by <code class="language-plaintext highlighter-rouge">Hooks</code>. It reminds me of the good old days when I was using <code class="language-plaintext highlighter-rouge">Haskell</code> , where a huge amount of states were chained together and worked like a miracle (yes, sadly I have to admit it is the feeling of functional programming that attracts me, and <code class="language-plaintext highlighter-rouge">React</code>.js is not really more elegant than <code class="language-plaintext highlighter-rouge">vue.js</code> in my opinion). Anyway, I feel the urge to explore a better, more “reacty” way of encapsulating HTTP requests. Here is what most bloggers suggest (you can see a bunch of them by searching for <code class="language-plaintext highlighter-rouge">react useApi hook</code>).</p><div class="language-react highlighter-rouge"><div class="code-header"> <span text-data=" React "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">useApi</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">apiState</span> <span class="o">=</span> <span class="nx">useApiState</span><span class="p">()</span> 
    
    <span class="c1">// use `result` state to record server's response for this request</span>
    <span class="kd">const</span> <span class="p">[</span><span class="nx">result</span><span class="p">,</span> <span class="nx">setResult</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">()</span> 
    
    <span class="nx">useEffect</span><span class="p">(()</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="nx">lib</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">apiState</span><span class="p">.</span><span class="nx">server_root</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setResult</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span>
        	<span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setResult</span><span class="p">(</span><span class="kc">null</span><span class="p">))</span>
    <span class="p">},</span> <span class="p">[</span><span class="nx">url</span><span class="p">])</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="nx">result</span><span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><p>In a component, we can do the following</p><div class="language-jsx highlighter-rouge"><div class="code-header"> <span text-data=" Jsx "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
</pre><td class="rouge-code"><pre><span class="kd">function</span> <span class="nx">SomeComponent</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="p">[</span><span class="nx">data</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useApi</span><span class="p">(</span><span class="dl">'</span><span class="s1">/user</span><span class="dl">'</span><span class="p">)</span>
    <span class="k">return</span> <span class="p">&lt;</span><span class="nc">DOM1</span> <span class="na">state</span><span class="p">=</span><span class="si">{</span><span class="nx">data</span><span class="si">}</span><span class="p">&gt;</span>
}
</pre></table></code></div></div><p>With this approach, we can encapsulate all HTTP request related logic in the <code class="language-plaintext highlighter-rouge">useApi</code> call. This looks nice, but it is to restricted because:</p><ul><li>It does not support path parameters, and there is no way to change the <code class="language-plaintext highlighter-rouge">url</code> of the request. Suppose we want to call <code class="language-plaintext highlighter-rouge">https://example.com/user?first=paul&amp;last=chen</code> with <code class="language-plaintext highlighter-rouge">first</code> and <code class="language-plaintext highlighter-rouge">last</code> parameters from input boxes, this approach simply can’t do this. For the same reason, POST requests with a dynamic <code class="language-plaintext highlighter-rouge">requestBody</code> are not supported.<li>By defining <code class="language-plaintext highlighter-rouge">useApi</code> this way, we explicitly assume the purpose of this request is to retrieve some data and stored in <code class="language-plaintext highlighter-rouge">result</code> state. However, some requests may require an additional callback (e.g., jump to another page, change another variable), which is not supported by this design.<li>The request is sent at loading time. There is no way to manually sending the request again (e.g., when the user clicks a refresh button)<li><code class="language-plaintext highlighter-rouge">setResult</code> is not exposed to the outside world. The only way to update the state is through sending a request and getting a new result. If you want to allow changing the state to trigger a re-render of a page, you have to use ugly hacks.</ul><p>Sadly, the top 10 tutorials I found on encapsulating HTTP calls with <code class="language-plaintext highlighter-rouge">Hooks</code> all stopped here. Even the established libraries (e.g., <a href="https://npmjs.com/package/react-use-api"><code class="language-plaintext highlighter-rouge">react-use-api</code></a>) fail to address all of the problems above. This keeps me thinking, isn’t this scenario so common that there should have been a very good solution out there?</p><h1 id="building-on-solutions-from-others-w-hooks">Building on Solutions From Others (w/ Hooks)</h1><p>To address the issues mentioned above, I tweaked (if not reformulated entirely) previous solution. Here is a list of things I did.</p><h2 id="allow-triggering-any-time">Allow Triggering Any Time</h2><p>Instead of wrapping <code class="language-plaintext highlighter-rouge">lib.get()</code> in <code class="language-plaintext highlighter-rouge">useEffect</code> call, I wrap it in a function and expose it to the caller of <code class="language-plaintext highlighter-rouge">useApi</code>. This allows triggering the request any time.</p><div class="language-react highlighter-rouge"><div class="code-header"> <span text-data=" React "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">useApi</span><span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">apiState</span> <span class="o">=</span> <span class="nx">useApiState</span><span class="p">()</span> 
    <span class="kd">const</span> <span class="p">[</span><span class="nx">result</span><span class="p">,</span> <span class="nx">setResult</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">()</span>
    
    <span class="kd">const</span> <span class="nx">sendRequest</span> <span class="o">=</span> <span class="p">()</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="c1">// Changed from useEffect to this to allow triggering any time</span>
        <span class="nx">lib</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">apiState</span><span class="p">.</span><span class="nx">server_root</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setResult</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span>
        	<span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setResult</span><span class="p">(</span><span class="kc">null</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="k">return</span> <span class="p">[</span><span class="nx">result</span><span class="p">,</span> <span class="nx">sendRequest</span><span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="allow-dynamic-url-and-data">Allow Dynamic URL and Data</h2><p>We accept an <code class="language-plaintext highlighter-rouge">url</code> parameter at the time of sending the request, instead of calling the hook. This allows sending requests with dynamic parameters decided at run time.</p><div class="language-react highlighter-rouge"><div class="code-header"> <span text-data=" React "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
</pre><td class="rouge-code"><pre>  <span class="kd">const</span> <span class="nx">useApi</span><span class="p">()</span> <span class="p">{</span> <span class="c1">// removed url parameter here</span>
      <span class="kd">const</span> <span class="nx">apiState</span> <span class="o">=</span> <span class="nx">useApiState</span><span class="p">()</span> 
      <span class="kd">const</span> <span class="p">[</span><span class="nx">result</span><span class="p">,</span> <span class="nx">setResult</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useState</span><span class="p">()</span>
      
      <span class="c1">// put url parameter here so that url can be dynamically changed at send time</span>
      <span class="kd">const</span> <span class="nx">sendRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">url</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> 
          <span class="nx">lib</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">apiState</span><span class="p">.</span><span class="nx">server_root</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
              <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setResult</span><span class="p">(</span><span class="nx">res</span><span class="p">.</span><span class="nx">data</span><span class="p">))</span>
          	<span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">setResult</span><span class="p">(</span><span class="kc">null</span><span class="p">))</span>
      <span class="p">}</span>
      
      <span class="k">return</span> <span class="p">[</span><span class="nx">result</span><span class="p">,</span> <span class="nx">sendRequest</span><span class="p">]</span>
  <span class="p">}</span>
</pre></table></code></div></div><h2 id="do-not-define-state-inside">Do Not Define State Inside</h2><p>As we mentioned above, defining a result state inside makes the <code class="language-plaintext highlighter-rouge">useApi</code> hooks much less generic. Instead, we require the caller of <code class="language-plaintext highlighter-rouge">sendRequest</code> to provide callback functions, which allows the most customization. If the caller wants to define a state, it can still define it in a component, and update it in the callback. This logic can also be shared across multiple components easily just like other logic.</p><div class="language-react highlighter-rouge"><div class="code-header"> <span text-data=" React "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">useApi</span><span class="p">()</span> <span class="p">{</span>
    <span class="c1">// we no long need `result` state</span>
    <span class="kd">const</span> <span class="nx">apiState</span> <span class="o">=</span> <span class="nx">useApiState</span><span class="p">()</span> 
    
    <span class="c1">// accept success and fail callbacks here</span>
    <span class="kd">const</span> <span class="nx">sendRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">onSucc</span><span class="p">,</span> <span class="nx">onFail</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> 
        <span class="nx">lib</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">apiState</span><span class="p">.</span><span class="nx">server_root</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
            <span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">onSucc</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>
        	<span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">onFail</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
    <span class="p">}</span>
    
    <span class="c1">// we no longer expose a `result` state</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">sendRequest</span><span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="supporting-multiple-request-types">Supporting Multiple Request Types</h2><p>We can easily extend this template to support multiple request types.</p><div class="language-react highlighter-rouge"><div class="code-header"> <span text-data=" React "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">useApi</span><span class="p">()</span> <span class="p">{</span>
    <span class="kd">const</span> <span class="nx">apiState</span> <span class="o">=</span> <span class="nx">useApiState</span><span class="p">()</span> 
    
    <span class="c1">// accept an additional requestType and (optional) requestBody parameter</span>
    <span class="c1">// send different request accordingly</span>
    <span class="kd">const</span> <span class="nx">sendRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">requestType</span><span class="p">,</span> <span class="nx">onSucc</span><span class="p">,</span> <span class="nx">onFail</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> 
        <span class="kd">let</span> <span class="nx">promise</span><span class="p">;</span>
        <span class="k">switch</span> <span class="nx">requestType</span> <span class="p">{</span>
            <span class="k">case</span> <span class="na">GET</span><span class="p">:</span>
                <span class="nx">promise</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="kd">get</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">apiState</span><span class="p">.</span><span class="nx">server_root</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="na">POST</span><span class="p">:</span>
                <span class="nx">promise</span> <span class="o">=</span> <span class="nx">lib</span><span class="p">.</span><span class="nx">post</span><span class="p">(</span><span class="s2">`</span><span class="p">${</span><span class="nx">apiState</span><span class="p">.</span><span class="nx">server_root</span><span class="p">}</span><span class="s2">/</span><span class="p">${</span><span class="nx">url</span><span class="p">}</span><span class="s2">`</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">)</span>
                <span class="k">break</span><span class="p">;</span>
            <span class="k">case</span> <span class="na">DELETE</span><span class="p">:</span>
                <span class="c1">// ... all other types</span>
        <span class="p">}</span>
        <span class="nx">promise</span><span class="p">.</span><span class="nx">then</span><span class="p">((</span><span class="nx">res</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">onSucc</span><span class="p">(</span><span class="nx">res</span><span class="p">))</span>
        	<span class="p">.</span><span class="k">catch</span><span class="p">((</span><span class="nx">err</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="nx">onFail</span><span class="p">(</span><span class="nx">err</span><span class="p">))</span>
    <span class="p">}</span>

    <span class="k">return</span> <span class="p">[</span><span class="nx">sendRequest</span><span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><h2 id="additional-encapsulation-for-each-end-point-good-to-go">Additional Encapsulation For Each End Point, Good To Go!</h2><p>The <code class="language-plaintext highlighter-rouge">useApi</code> is done. We now need to consider how to use <code class="language-plaintext highlighter-rouge">useApi</code>. The caller (i.e., the components) will need to provide parameters to <code class="language-plaintext highlighter-rouge">sendRequest</code> function:</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">sendRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">requestType</span><span class="p">,</span> <span class="nx">onSucc</span><span class="p">,</span> <span class="nx">onFail</span><span class="p">,</span> <span class="nx">requestBody</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span> <span class="p">...</span> <span class="p">}</span>
</pre></table></code></div></div><p>Recall that our goal is to <strong>make the components ignorant of the intricacies of HTTP requests</strong>, so we don’t want to do this in the component logic</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="p">[</span><span class="nx">sendRequest</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useApi</span><span class="p">()</span>
<span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`/user?first=</span><span class="p">${</span><span class="nx">userInputFirst</span><span class="p">}</span><span class="s2">&amp;last=</span><span class="p">${</span><span class="nx">userInputLast</span><span class="p">}</span><span class="s2">`</span> <span class="c1">// construct endpoint url</span>
<span class="kd">const</span> <span class="nx">sendRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">GET</span><span class="p">,</span> <span class="p">...)</span>
</pre></table></code></div></div><p>This to me is too ugly, because you are hard-coding the request URL template inside a component. You probably need to hard-code it multiple times if multiple components use this endpoint. Thus, let’s do an encapsulation for this endpoint.</p><div class="language-react highlighter-rouge"><div class="code-header"> <span text-data=" React "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
3
4
5
6
7
8
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="nx">useAPIGetUser</span><span class="p">(</span><span class="nx">onSucc</span><span class="p">,</span> <span class="nx">onFail</span><span class="p">)</span> <span class="p">{</span>
	<span class="kd">const</span> <span class="p">[</span><span class="nx">sendRequest</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useApi</span><span class="p">()</span>
	<span class="kd">const</span> <span class="nx">sendGetUsersRequest</span> <span class="o">=</span> <span class="p">(</span><span class="nx">first</span><span class="p">,</span> <span class="nx">last</span><span class="p">)</span> <span class="o">=&gt;</span> <span class="p">{</span>
        <span class="kd">const</span> <span class="nx">url</span> <span class="o">=</span> <span class="s2">`/user?first=</span><span class="p">${</span><span class="nx">first</span><span class="p">}</span><span class="s2">&amp;last=</span><span class="p">${</span><span class="nx">last</span><span class="p">}</span><span class="s2">`</span>
        <span class="nx">sendRequest</span><span class="p">(</span><span class="nx">url</span><span class="p">,</span> <span class="nx">GET</span><span class="p">,</span> <span class="nx">onSucc</span><span class="p">,</span> <span class="nx">onFail</span><span class="p">)</span>
    <span class="p">}</span>
    <span class="k">return</span> <span class="p">[</span><span class="nx">sendGetUsersRequest</span><span class="p">]</span>
<span class="p">}</span>
</pre></table></code></div></div><p>Then, in any component, all we need to do is</p><div class="language-javascript highlighter-rouge"><div class="code-header"> <span text-data=" JavaScript "><i class="fa-fw fas fa-code small"></i></span> <button aria-label="copy" title-succeed="Copied!"><i class="far fa-clipboard"></i></button></div><div class="highlight"><code><table class="rouge-table"><tbody><tr><td class="rouge-gutter gl"><pre class="lineno">1
2
</pre><td class="rouge-code"><pre><span class="kd">const</span> <span class="p">[</span><span class="nx">sendRequest</span><span class="p">]</span> <span class="o">=</span> <span class="nx">useAPIGetUser</span><span class="p">(</span><span class="nx">onSucc</span><span class="p">,</span> <span class="nx">onFail</span><span class="p">)</span> <span class="c1">// define callbacks</span>
<span class="nx">sendRequest</span><span class="p">(</span><span class="nx">userInputFirst</span><span class="p">,</span> <span class="nx">userInputLast</span><span class="p">)</span> <span class="c1">// send the request</span>
</pre></table></code></div></div><p>There is no HTTP Request related stuff here. All the component knows is that it calls some function and updates its states with callbacks defined within the component. We can simply define one <code class="language-plaintext highlighter-rouge">useAPIxxx</code> hook for each API endpoint, and put them all in one folder, so that everything related to sending requests will be there.</p><h1 id="closing-remarks">Closing Remarks</h1><p>This has been the most elegant and clean way to encapsulate HTTP calls that I can think of (after all the mind struggles and research). However, it does lead to what’s known as callback hell: the component is filled with arrow functions (because of the excessive use of callbacks), and the logic is a bit weird to follow. We could easily change our template to <code class="language-plaintext highlighter-rouge">async/await</code> style of sending requests: you can just return the result of the inner most <code class="language-plaintext highlighter-rouge">lib.get</code> out layer by layer instead of calling <code class="language-plaintext highlighter-rouge">then</code> on it. Personally I think it’s OK to leave it as callbacks as it encourages me not to write nested code, which is usually an indicator of bad code design.</p><p>To implement <code class="language-plaintext highlighter-rouge">useApiState</code>, you can use different methods to store different states. For example, use login status may be stored with React <code class="language-plaintext highlighter-rouge">Context API</code> and <code class="language-plaintext highlighter-rouge">LocalStorage</code>, and throttling information can be handled with a state manager such as <code class="language-plaintext highlighter-rouge">Redux</code>.</p></div><div class="post-tail-wrapper text-muted"><div class="post-meta mb-3"> <i class="far fa-folder-open fa-fw mr-1"></i> <a href='/categories/software-development/'>Software Development</a>, <a href='/categories/frontend/'>Frontend</a></div><div class="post-tags"> <i class="fa fa-tags fa-fw mr-1"></i> <a href="/tags/notes/" class="post-tag no-text-decoration" >notes</a> <a href="/tags/experience/" class="post-tag no-text-decoration" >experience</a> <a href="/tags/tutorials/" class="post-tag no-text-decoration" >tutorials</a> <a href="/tags/software-engineering/" class="post-tag no-text-decoration" >software engineering</a> <a href="/tags/react/" class="post-tag no-text-decoration" >react</a> <a href="/tags/frontend/" class="post-tag no-text-decoration" >frontend</a> <a href="/tags/english/" class="post-tag no-text-decoration" >english</a></div><div class="post-tail-bottom d-flex justify-content-between align-items-center mt-3 pt-5 pb-2"><div class="license-wrapper"> This post is licensed under <a href="https://creativecommons.org/licenses/by/4.0/"> CC BY 4.0 </a> by the author.</div><div class="share-wrapper"> <span class="share-label text-muted mr-1">Share</span> <span class="share-icons"> <a href="https://twitter.com/intent/tweet?text=On Encapsulating HTTP Requests with React Hooks - Chonghan Chen&url=https://paulcccccch.github.io/posts/frontend-react-request-with-hooks/" data-toggle="tooltip" data-placement="top" title="Twitter" target="_blank" rel="noopener" aria-label="Twitter"> <i class="fa-fw fab fa-twitter"></i> </a> <a href="https://www.facebook.com/sharer/sharer.php?title=On Encapsulating HTTP Requests with React Hooks - Chonghan Chen&u=https://paulcccccch.github.io/posts/frontend-react-request-with-hooks/" data-toggle="tooltip" data-placement="top" title="Facebook" target="_blank" rel="noopener" aria-label="Facebook"> <i class="fa-fw fab fa-facebook-square"></i> </a> <a href="https://telegram.me/share?text=On Encapsulating HTTP Requests with React Hooks - Chonghan Chen&url=https://paulcccccch.github.io/posts/frontend-react-request-with-hooks/" data-toggle="tooltip" data-placement="top" title="Telegram" target="_blank" rel="noopener" aria-label="Telegram"> <i class="fa-fw fab fa-telegram"></i> </a> <i id="copy-link" class="fa-fw fas fa-link small" data-toggle="tooltip" data-placement="top" title="Copy link" title-succeed="Link copied successfully!"> </i> </span></div></div></div></div></div><div id="panel-wrapper" class="col-xl-3 pl-2 text-muted topbar-down"><div class="access"><div id="access-lastmod" class="post"> <span>Recent Update</span><ul class="post-content pl-0 pb-1 ml-1 mt-2"><li><a href="/posts/prelude/">Prelude</a><li><a href="/posts/backend-spring/">Backend Recipe for Beginners (Springboot + MyBatis)</a></ul></div><div id="access-tags"> <span>Trending Tags</span><div class="d-flex flex-wrap mt-3 mb-1 mr-3"> <a class="post-tag" href="/tags/notes/">notes</a> <a class="post-tag" href="/tags/english/">english</a> <a class="post-tag" href="/tags/machine-learning/">machine learning</a> <a class="post-tag" href="/tags/maths/">maths</a> <a class="post-tag" href="/tags/tutorials/">tutorials</a> <a class="post-tag" href="/tags/chinese/">chinese</a> <a class="post-tag" href="/tags/personal/">personal</a> <a class="post-tag" href="/tags/writing/">writing</a> <a class="post-tag" href="/tags/software-engineering/">software engineering</a> <a class="post-tag" href="/tags/creative/">creative</a></div></div></div><script src="https://cdn.jsdelivr.net/gh/afeld/bootstrap-toc@1.0.1/dist/bootstrap-toc.min.js"></script><div id="toc-wrapper" class="pl-0 pr-4 mb-5"> <span class="pl-3 pt-2 mb-2">Contents</span><nav id="toc" data-toggle="toc"></nav></div></div></div><div class="row"><div class="col-12 col-lg-11 col-xl-8"><div id="post-extend-wrapper" class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-md-4 pr-md-4"><div id="related-posts" class="mt-5 mb-2 mb-sm-4"><h3 class="pt-2 mt-1 mb-4 ml-1" data-toc-skip>Further Reading</h3><div class="card-deck mb-4"><div class="card"> <a href="/posts/onnx-runtime-web/"><div class="card-body"> <span class="timeago small" >Apr 4, 2021<i class="unloaded">2021-04-04T22:17:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Recommendation System with Perfect Privacy - ONNX Runtime Web</h3><div class="text-muted small"><p> Recommendation System with Perfect Privacy - ONNX Runtime Web The source code of the demo project is available here. Prelude Sometime ago, a friend of mine drove me to a party with his new car. ...</p></div></div></a></div><div class="card"> <a href="/posts/se-and-tools/"><div class="card-body"> <span class="timeago small" >Apr 14, 2021<i class="unloaded">2021-04-14T04:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>软件工程流程和心得</h3><div class="text-muted small"><p> I wrote this for the m5-201 course, which aims at preparing new programmers for real full-stack development and tech team leader roles. 引言 其实，一个软件从无到有的过程中，书写代码只占了一小部分而已。 与其它工程项目（比如造房子、发火箭、修铁路）一样...</p></div></div></a></div><div class="card"> <a href="/posts/backend-spring/"><div class="card-body"> <span class="timeago small" >May 12, 2021<i class="unloaded">2021-05-12T04:00:00-04:00</i> </span><h3 class="pt-0 mt-1 mb-3" data-toc-skip>Backend Recipe for Beginners (Springboot + MyBatis)</h3><div class="text-muted small"><p> I wrote this for the m5-201 course, which aims at preparing new programmers for real full-stack development and tech team leader roles. 后端开发规范 在开始着手做以下内容之前，请务必先把产品的逻辑梳理得井井有条。该用到 UML、该写文档的地方，绝对不要节省...</p></div></div></a></div></div></div><div class="post-navigation d-flex justify-content-between"> <a href="/posts/cmu-sem2/" class="btn btn-outline-primary" prompt="Older"><p>CMU第一学年进化日志</p></a> <span class="btn btn-outline-primary disabled" prompt="Newer"><p>-</p></span></div></div></div></div><footer class="d-flex w-100 justify-content-center"><div class="d-flex justify-content-between align-items-center"><div class="footer-left"><p class="mb-0"> © 2023 <a href="https://twitter.com/paulcccccch">Chonghan Chen</a>. <span data-toggle="tooltip" data-placement="top" title="Except where otherwise noted, the blog posts on this site are licensed under the Creative Commons Attribution 4.0 International (CC BY 4.0) License by the author." >Some rights reserved.</span ></p></div><div class="footer-right"><p class="mb-0"> Powered by <a href="https://jekyllrb.com" target="_blank" rel="noopener">Jekyll</a></p></div></div></footer></div><div id="search-result-wrapper" class="d-flex justify-content-center unloaded"><div class="col-12 col-sm-11 post-content"><div id="search-hints"><h4 class="text-muted mb-4">Trending Tags</h4><a class="post-tag" href="/tags/notes/">notes</a> <a class="post-tag" href="/tags/english/">english</a> <a class="post-tag" href="/tags/machine-learning/">machine learning</a> <a class="post-tag" href="/tags/maths/">maths</a> <a class="post-tag" href="/tags/tutorials/">tutorials</a> <a class="post-tag" href="/tags/chinese/">chinese</a> <a class="post-tag" href="/tags/personal/">personal</a> <a class="post-tag" href="/tags/writing/">writing</a> <a class="post-tag" href="/tags/software-engineering/">software engineering</a> <a class="post-tag" href="/tags/creative/">creative</a></div><div id="search-results" class="d-flex flex-wrap justify-content-center text-muted mt-3"></div></div></div></div><div id="mask"></div><a id="back-to-top" href="#" aria-label="back-to-top" class="btn btn-lg btn-box-shadow" role="button"> <i class="fas fa-angle-up"></i> </a> <script src="https://cdn.jsdelivr.net/npm/simple-jekyll-search@1.10.0/dest/simple-jekyll-search.min.js"></script> <script> SimpleJekyllSearch({ searchInput: document.getElementById('search-input'), resultsContainer: document.getElementById('search-results'), json: '/assets/js/data/search.json', searchResultTemplate: '<div class="pl-1 pr-1 pl-sm-2 pr-sm-2 pl-lg-4 pr-lg-4 pl-xl-0 pr-xl-0"> <a href="{url}">{title}</a><div class="post-meta d-flex flex-column flex-sm-row text-muted mt-1 mb-1"> {categories} {tags}</div><p>{snippet}</p></div>', noResultsText: '<p class="mt-5">Oops! No result founds.</p>', templateMiddleware: function(prop, value, template) { if (prop === 'categories') { if (value === '') { return `${value}`; } else { return `<div class="mr-sm-4"><i class="far fa-folder fa-fw"></i>${value}</div>`; } } if (prop === 'tags') { if (value === '') { return `${value}`; } else { return `<div><i class="fa fa-tag fa-fw"></i>${value}</div>`; } } } }); </script> <script src="https://cdn.jsdelivr.net/combine/npm/lozad/dist/lozad.min.js,npm/magnific-popup@1/dist/jquery.magnific-popup.min.js,npm/clipboard@2/dist/clipboard.min.js"></script> <script defer src="/assets/js/dist/post.min.js"></script> <script src="https://cdn.jsdelivr.net/combine/npm/popper.js@1.16.1,npm/bootstrap@4/dist/js/bootstrap.min.js"></script> <script defer src="/app.js"></script> <script defer src="https://www.googletagmanager.com/gtag/js?id="></script> <script> document.addEventListener("DOMContentLoaded", function(event) { window.dataLayer = window.dataLayer || []; function gtag(){dataLayer.push(arguments);} gtag('js', new Date()); gtag('config', ''); }); </script>
